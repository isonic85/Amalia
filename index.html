<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Amalias Offline App</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e1e;
      color: white;
      padding: 2em;
    }
    .veckoblock {
      background: #2c2c2c;
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 1em;
      page-break-inside: avoid;
    }
    h2 {
      margin-top: 0;
    }
    input, button, select, .exInput {
      padding: 0.4em;
      font-size: 0.7em;
      margin: 0.5em 0;
      border-radius: 4px;
      border: none;
    }
    button {
      cursor: pointer;
      margin-right: 0.5em;
    }
    ul {
      padding-left: 0;
      margin: 0.5em 0 0;
    }
    li {
      list-style: none;
      margin-bottom: 0.4em;
      display: flex;
      align-items: center;
      gap: 0.8em;
    }
    select, .exInput {
      background: #fff;
      color: #000;
    }
    .exInput {
      flex: 1;
    }
    .dagLabel {
      min-width: 160px;
      text-transform: capitalize;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <h1>Amalias schema</h1>
  <label>Startdatum f√∂r Niklas arbetsdag (14/21 rotation):</label><br>
  <input type="date" id="startDate"><br>
  <label>V√§lj √•r:</label>
  <input type="number" id="year" value="2025" min="2024" max="2030"><br>
  <button onclick="generateSchedule()">Generera schema</button>
  <button onclick="generatePDF()">Ladda ner schema som PDF</button>
  <button onclick="clearAll()">üóëÔ∏è Rensa schema</button>
  <div id="result"></div>

  <script>
    function resetTime(d) {
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function saveField(id, value) {
      localStorage.setItem(id, value);
    }

    function loadField(id) {
      return localStorage.getItem(id) || '';
    }

    function clearAll() {
  if (confirm("√Ñr du s√§ker p√• att du vill rensa allt?")) {
    localStorage.clear();

    document.querySelectorAll("select").forEach(sel => sel.value = "");
    document.querySelectorAll(".exInput").forEach(inp => inp.value = "");
    document.getElementById("result").innerHTML = "";

    document.getElementById("startDate").value = "";
    document.getElementById("year").value = new Date().getFullYear();

    alert("Allt har rensats.");

    // üîÑ Generera nytt tomt schema direkt
    setTimeout(() => {
      generateSchedule();
    }, 100);
  }
}


    function generateSchedule() {
      const startDateInput = document.getElementById('startDate').value;
      if (!startDateInput) {
        alert('V√§nligen ange ett giltigt startdatum.');
        return;
      }

      const startDate = resetTime(new Date(startDateInput));
      const year = parseInt(document.getElementById('year').value);
      const result = document.getElementById('result');
      result.innerHTML = '';

      const oneDay = 86400000;
      const f√∂rstaByte = resetTime(new Date(startDate.getTime() - oneDay));
      let current = new Date(year, 0, 1);
      let weekNum = 1;

      while (current.getFullYear() === year) {
        const monday = new Date(current);
        while (monday.getDay() !== 1) monday.setDate(monday.getDate() - 1);
        resetTime(monday);

        const weekEnd = new Date(monday.getTime() + 6 * oneDay);
        resetTime(weekEnd);

        if (weekEnd < f√∂rstaByte) {
          current.setDate(current.getDate() + 7);
          weekNum++;
          continue;
        }

        const daysSinceStart = Math.floor((monday - startDate) / oneDay);
        const cycleDay = ((daysSinceStart % 35) + 35) % 35;
        const cycleNumber = Math.floor((monday - startDate) / (35 * oneDay));

        const handOverToHer = resetTime(new Date(startDate.getTime() + cycleNumber * 35 * oneDay - oneDay));
        const handOverToYou = resetTime(new Date(startDate.getTime() + cycleNumber * 35 * oneDay + 14 * oneDay));
        const handOverToHerAgain = resetTime(new Date(startDate.getTime() + cycleNumber * 35 * oneDay + 34 * oneDay));

        let barnHos = '';
        let byteText = '';

        if (monday <= handOverToHer && handOverToHer <= weekEnd) {
          byteText += `üë¶ Barn l√§mnas till henne: ${handOverToHer.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' })}<br>`;
        }
        if (monday <= handOverToYou && handOverToYou <= weekEnd) {
          byteText += `üëß Barn kommer till dig: ${handOverToYou.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' })}<br>`;
        }
        if (monday <= handOverToHerAgain && handOverToHerAgain <= weekEnd) {
          byteText += `üë¶ Barn l√§mnas till henne: ${handOverToHerAgain.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' })}<br>`;
        }

        if (cycleDay >= 0 && cycleDay <= 13) {
          barnHos = 'üë® Barn hos henne (du jobbar)';
        } else if (cycleDay >= 14 && cycleDay <= 20) {
          barnHos = 'üë© Barn hos dig (f√∂rsta veckan)';
        } else if (cycleDay >= 21 && cycleDay <= 27) {
          barnHos = 'üë® Barn hos henne (mittenvecka)';
        } else if (cycleDay >= 28 && cycleDay <= 33) {
          barnHos = 'üë© Barn hos dig (sista veckan)';
        } else if (cycleDay === 34) {
          barnHos = 'üîÅ Byte dag ‚Äì du l√§mnar barnen';
        }

        // Lista med dag + select + input
        let dagarHTML = '<ul>';
        for (let i = 0; i < 7; i++) {
          const day = new Date(monday.getTime() + i * oneDay);
          const dagText = day.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' });
          const fieldId = `week${weekNum}_day${i}`;
          const inputId = `week${weekNum}_day${i}_ex`;

          const savedSelect = loadField(fieldId);
          const savedText = loadField(inputId);

          dagarHTML += `
            <li>
              <span class="dagLabel">${dagText}</span>
              <select id="${fieldId}" onchange="saveField('${fieldId}', this.value)">
                <option value="">‚Äì V√§lj ‚Äì</option>
                <option value="Dollar Store" ${savedSelect === 'Dollar Store' ? 'selected' : ''}>Dollar Store</option>
                <option value="Passteam" ${savedSelect === 'Passteam' ? 'selected' : ''}>Passteam</option>
              </select>
              <input type="text" class="exInput" id="${inputId}" value="${savedText}" placeholder="Ex..." oninput="saveField('${inputId}', this.value)">
            </li>`;
        }
        dagarHTML += '</ul>';

        const block = document.createElement('div');
        block.className = 'veckoblock';
        block.innerHTML = `
          <h2>üìÖ Vecka ${weekNum} (${monday.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('sv-SE', { day: 'numeric', month: 'short' })})</h2>
          <p>${barnHos}</p>
          <p>${byteText}</p>
          
          ${dagarHTML}
        `;
        result.appendChild(block);

        current.setDate(current.getDate() + 7);
        weekNum++;
      }
    }

    function generatePDF() {
      const element = document.getElementById('result');
      const opt = {
        margin: 0.3,
        filename: 'barnschema.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
